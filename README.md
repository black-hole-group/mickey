Mickey: Python scripts to tame Pluto
=======================================

![](http://www.queen-of-theme-party-games.com/images/mickey-mouse-party-ideas-21678345.gif) 

Assorted methods and classes to handle and visualize the output of the [Pluto MHD code](https://github.com/black-hole-group/pluto).

# Requirements

- [`pyPluto`](https://github.com/black-hole-group/pyPLUTO) which contains the module to read binary files generated by Pluto
- [`nmmn`](https://github.com/rsnemmen/nmmn): supporting python modules for scientific analysis.
- [OPTIONAL] [PGI compiler](https://www.pgroup.com) (`pgcc`) compiler to make use of GPU or CPU acceleration for fast array handling. Only required for changing coordinate basis (i.e. regridding; cf. [C extensions](#c-extensions)).
- [OPTIONAL] SWIG: needed to interface the python modules and fast C routines.

# Installation

1.. Make sure you have `pyPluto` installed (ignore this step if you already installed it):

```shell 
git clone git@github.com:black-hole-group/pyPLUTO.git
```

2.. Install [`nmmn`](https://github.com/rsnemmen/nmmn) (ignore this step if you already installed it)

    pip install nmmn

Keep in mind that `nmmn` and `Mickey` are being continuously updated. To get their bleeding-edge versions, it is recommended to install using the `python setup.py develop` method, `cd` to the directory where the packages are located and issue a `git pull`. 

3.. Setup environment variables for Pluto and the python scripts, to make sure that they will be found when needed

```shell
export PLUTO_DIR=/home/user/pluto
export PYTHONPATH=/home/user/pyPLUTO:/home/user/mickey/src:$PYTHONPATH
```

Add the above lines to your `.bash_profile` (MacOS) or `.bashrc` (Linux) file for convenience.

4.. *OPTIONAL* Install the [PGI compilers](https://www.pgroup.com). GPU acceleration is only supported in Linux.

5.. *OPTIONAL* Install SWIG.

```shell
sudo apt install swig # installs system-wide
conda install swig # installs for anaconda distro
```

6.. Install `Mickey`,

```shell
git clone git@bitbucket.org:nemmen/mickey.git
cd mickey
```

You have now two options to install Mickey. You can:

i. install the module on the systemâ€™s python library path 

```
python setup.py install  # compile C extensions and install
```

or...

ii. install the package with a symlink, so that changes to the source files will be immediately available:

```
python setup.py develop
``` 

This last method is preferred since it allows for easily updating Mickey to the latest changes in the repo (`git pull`). You may need to run the last command with `sudo`. Also, if the C extension source code was updated, you will need to recompile these extensions.

## C extensions

Mickey includes a couple of C extensions for speeding up some array operations which are too slow in Python (e.g. changing the coordinate basis of an array). They are located at `./src`. When running the setup commands above, the C extensions should be automatically compiled with the PGI compiler (`pgcc`). 

If you want to compile them yourself, just change to the `src` directory and issue

    make

By default, mickey will compile with GPU support enabled for
a NVIDIA GPU. If you want to disable the GPU, please use

    make CPU=1
(it does not really matter what comes after the `=` above).

---
**NOTE**

GPUs can speed up regridding by a factor of 100 compared to CPU w/ pure Python (`regrid`), and 5-10x compared to CPU w/ C (`make CPU=1`).

---



# Usage
	
Please see the jupyter notebook `mickey-tutorial.ipynb` which has several examples on how to use Mickey.


# Branch explanation

- `master`: stable branch, with recommended optimizations (one hopes)
- `openacc`: fast and furious regridding. NVIDIA GPU recommended for max speed
- `swig`: C-extensions for faster regridding, incorporated through `SWIG`. Serial code
- `openmp`: C-extensions for optimization, SWIG interface, OpenMP acceleration. Very similar to branch `swig`
- `opencl`: ~~by far the fastest optimization,~~ incorporated using C and `PyOpenCL`

# TODO

- [x] compute total mass in volume
- [x] compute Mdot for a given radius
- [ ] compute energy, 
- [x] a.m. 
- [ ] compute how much mass was lost from the volume due to outflows
- [x] script to mirror local files to `alphacrucis`, for easy compilation
- [x] write a CPU only version for branch openacc
- [ ] more examples, put them in a jupyter notebook

